name: Minecraft Server Pixelmon

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Start-Server]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v3

      - name: ğŸ“ Prepare dirs
        run: mkdir -p .backup

      - name: ğŸ’¾ Restore backup (optional)
        run: |
          name="${{ github.event.client_payload.server_name || 'server-minecraft' }}"
          if [ "${{ github.event.client_payload.backup }}" == "true" ]; then
            unzip ".backup/$name.zip" -d . || echo "âš ï¸ No backup found."
          fi

      - name: ğŸ” Start tmate session (download server)
        run: |

      - name: ğŸš€ Start Playit Tunnel
        run: |
          wget -q https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64 -O playit
          chmod +x playit
          nohup ./playit --secret 27b8c3d202823e43416721a8b026d78847f62426a54e14031fb2314d7d05bfcd > playit.log 2>&1 &
          echo "âœ… Playit started in background."

      - name: â–¶ï¸ Run Minecraft server
        run: |
          echo "eula=true" > eula.txt
          nohup java -Xms1G -Xmx6G -jar server.jar nogui &
          echo $! > minecraft.pid
          echo "âœ… Server restarted successfully (new PID: $(cat minecraft.pid))"

      - name: â³ Keep Server alive
        run: |
          pid_file="minecraft.pid"

          # Náº¿u chÆ°a cÃ³ PID file thÃ¬ bÃ¡o lá»—i vÃ  dá»«ng
          if [ ! -f "$pid_file" ]; then
            echo "âŒ PID file not found â€” server may not be running."
            exit 1
          fi

          pid=$(cat "$pid_file")
          echo "ğŸ“¡ Monitoring Minecraft server (PID: $pid)..."

          # Kiá»ƒm tra trong 3 giá» (5 giÃ¢y/láº§n = 2160 láº§n)
          for i in $(seq 1 2160); do
            if ps -p "$pid" > /dev/null 2>&1; then
              echo "âœ… Server (PID $pid) is running (check $i/2160)..."
              sleep 5
            else
              echo "âš ï¸ Server stopped at check $i â€” will proceed to backup."
              exit 0
            fi
          done

          echo "â° Time limit reached (3h) â€” will proceed to backup."

      - name: ğŸ“¦ Save backup
        run: |
          name="${{ github.event.client_payload.server_name || 'server-minecraft' }}"
          zip -qr ".backup/$name.zip" . -x ".git/*" ".github/*" ".backup/*" || true

      - name: ğŸ“¤ Push updated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ” Updated backup"
          file_pattern: '.backup/*.zip'
