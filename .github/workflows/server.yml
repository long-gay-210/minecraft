name: Minecraft Server Pixelmon

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Start-Server]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours

    steps:
      - name: â¬‡ï¸ Download Server
        run: |
          wget -O b2 https://github.com/Backblaze/B2_Command_Line_Tool/releases/latest/download/b2-linux
          chmod +x b2
          sudo mv b2 /usr/local/bin/
          b2 account authorize 005f6a0bf64072a0000000002 K005O9tcKmCcdwwRDOjrKAOqhiDlsz4

      - name: ğŸ“ Prepare dirs
        run: |
          mkdir -p .backup
          b2 file download b2://server-minecraft-backup/server.zip ./.backup/server.zip

      - name: ğŸ’¾ Restore backup (optional)
        run: |
          if [ -f ".backup/server.zip" ]; then
            unzip -o ".backup/server.zip" -d .
            echo "âœ… Backup restored."
          else
            echo "âš ï¸ No backup found."
          fi

      - name: ğŸš€ Start Playit Tunnel
        run: |
          wget -q https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64 -O playit
          chmod +x playit
          nohup ./playit --secret 27b8c3d202823e43416721a8b026d78847f62426a54e14031fb2314d7d05bfcd > playit.log 2>&1 &
          echo "âœ… Playit started in background."

      - name: â–¶ï¸ Run Minecraft server
        run: |
          sudo apt update
          sudo apt install -y openjdk-21-jdk
          sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/java-21-openjdk-amd64/bin/java 1
          sudo update-alternatives --set java /usr/lib/jvm/java-21-openjdk-amd64/bin/java
          java -version
          echo "eula=true" > eula.txt
          nohup java -Xms1G -Xmx6G -jar server.jar nogui &
          echo $! > minecraft.pid
          echo "âœ… Server restarted successfully (new PID: $(cat minecraft.pid))"

      - name: â³ Keep Server alive
        run: |
          pid_file="minecraft.pid"

          # Náº¿u chÆ°a cÃ³ PID file thÃ¬ bÃ¡o lá»—i vÃ  dá»«ng
          if [ ! -f "$pid_file" ]; then
            echo "âŒ PID file not found â€” server may not be running."
            exit 1
          fi

          pid=$(cat "$pid_file")
          echo "ğŸ“¡ Monitoring Minecraft server (PID: $pid)..."

          # Kiá»ƒm tra trong 3 giá» (5 giÃ¢y/láº§n = 2160 láº§n)
          for i in $(seq 1 2160); do
            if ps -p "$pid" > /dev/null 2>&1; then
              echo "âœ… Server (PID $pid) is running (check $i/2160)..."
              sleep 5
            else
              echo "âš ï¸ Server stopped at check $i â€” will proceed to backup."
              exit 0
            fi
          done

          echo "â° Time limit reached (3h) â€” will proceed to backup."

      - name: ğŸ“¦ Save backup
        run: |
          zip -qr ".backup/server.zip" . -x ".git/*" ".github/*" ".backup/*" || true
          echo "âœ… Backup saved as server.zip"

      - name: ğŸ“¤ Push updated files
        run: |
          # Kiá»ƒm tra file backup tá»“n táº¡i khÃ´ng
          if [ -f ".backup/server.zip" ]; then
            # Upload file lÃªn bucket server-minecraft-backup
            b2 file upload b2://server-minecraft-backup ./.backup/server.zip server.zip \
              || echo "âŒ Upload failed."
            echo "âœ… Backup uploaded to B2 as server.zip"
          else
            echo "âš ï¸ No backup file to upload."
          fi
