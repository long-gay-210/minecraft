name: Minecraft Server Pixelmon

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Start-Minecraft]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: ğŸ“ Prepare folders
        run: |
          mkdir -p .backup
          mkdir -p server

      - name: ğŸ’¾ Restore backup (optional)
        run: |
          if [ -f ".backup/backup.zip" ]; then
            unzip -o ".backup/backup.zip" -d server/
            echo "âœ… Backup restored"
          else
            echo "âš ï¸ No backup found"
          fi

      - name: â¬‡ï¸ Download Playit
        run: |
          wget -O playit https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64
          chmod +x playit
          nohup ./playit --secret 27b8c3d202823e43416721a8b026d78847f62426a54e14031fb2314d7d05bfcd &

      - name: â¬‡ï¸ Download server.zip from Google Drive
        run: |
          FILE_ID="1PhG0nAZZV-MATixEGAxKYbV2MMeexPVq"
          echo "â¬‡ï¸ Downloading server.zip from Drive..."
          wget --no-check-certificate "https://drive.google.com/uc?export=download&id=${FILE_ID}" -O server.zip
          echo "âœ… Download complete"

      - name: ğŸšš Move server.zip to server/
        run: mv server.zip server/

      - name: ğŸ“¦ Unzip server
        run: |
          cd server
          unzip -o server.zip
          rm server.zip
          echo "âœ… Server unzipped"

      - name: â–¶ï¸ Run Minecraft server
        run: |
          cd server
          echo "eula=true" > eula.txt
          nohup java -Xms1G -Xmx6G -jar server.jar nogui &

      - name: â³ Keep VPS alive
        run: |
          for i in $(seq 1 180); do
            echo "ğŸŸ¢ Running minute $i/180..."
            sleep 60
          done

      - name: ğŸ’¾ Backup server
        working-directory: server
        run: |
          mkdir -p ../.backup
          rm -f ../.backup/*.zip
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          BACKUP_FILE="../.backup/backup-$TIMESTAMP.zip"
          zip -r "$BACKUP_FILE" ./*
          echo "âœ… Backup completed: $BACKUP_FILE"

      - name: â¬†ï¸ Upload Minecraft backup
        uses: actions/upload-artifact@v4
        with:
          name: minecraft-backup
          path: .backup/*.zip
