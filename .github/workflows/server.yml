name: Minecraft Server Pixelmon

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Start-Server]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours

    steps:
      - name: â¬‡ï¸ Download Server
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: ğŸ“ Prepare dirs
        run: |
          echo "Creating rclone config..."
          REMOTE_NAME="server-backup"
          RCLONE_CONF="$HOME/.config/rclone/rclone.conf"
          mkdir -p "$(dirname "$RCLONE_CONF")"
          cat > "$RCLONE_CONF" <<EOL
          [$REMOTE_NAME]
          type = drive
          client_id = 177351678679-j77al4hco0vgu0rtut2abm5b5lmkig34.apps.googleusercontent.com
          client_secret = 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
          scope = drive
          token = {"access_token":"ya29.a0AQQ_BDSifCrCJbr79_A6XwifyY1PQ8eroN8ZPyuf1UHzGFC5ILTWReOqpTViQTJ1YQfxgwvT3goPQBEP3JwmHyPehFTkaed3U-RE51ctVttfg21h9SN6HURZ5q7H0VPVZF8hzHgfDRSvfpUJ60FeGzPf4LZdjDZ_jeKwvsQ5khr4dnMOXUdwYRgyLQ0T0qPuWGZ5F28aCgYKAfkSARMSFQHGX2MiH3XnI0aShRvkbtMDZM6IKw0206","token_type":"Bearer","refresh_token":"1//0e2O7UOQ46-HnCgYIARAAGA4SNwF-L9IroOcdI-89WyM0hhRssZPRdQd3Z8P0PQxYdC3g-BYmj7w5OmmF1mMlaB_4dxYv2jmBkIM","expiry":"2025-10-12T08:20:52.4800863+07:00","expires_in":3599}
          team_drive =
          EOL
          echo "Testing rclone..."
          rclone ls "$REMOTE_NAME": || { echo "Rclone test failed!"; exit 1; }
          mkdir -p .backup

      - name: ğŸ’¾ Restore backup (optional)
        run: |
          rclone copy server-backup:/server.zip .backup/ --transfers 16 --checkers 16
          if [ -f ".backup/server.zip" ]; then
            unzip -o ".backup/server.zip" -d .
            echo "âœ… Backup restored."
          else
            echo "âš ï¸ No backup found."
          fi

      - name: ğŸš€ Start Playit Tunnel
        run: |
          wget -q https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64 -O playit
          chmod +x playit
          nohup ./playit --secret 27b8c3d202823e43416721a8b026d78847f62426a54e14031fb2314d7d05bfcd > playit.log 2>&1 &
          echo "âœ… Playit started in background."

      - name: â–¶ï¸ Run Minecraft server
        run: |
          sudo apt update
          sudo apt install -y openjdk-21-jdk
          sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/java-21-openjdk-amd64/bin/java 1
          sudo update-alternatives --set java /usr/lib/jvm/java-21-openjdk-amd64/bin/java
          java -version
          echo "eula=true" > eula.txt
          nohup java -Xms1G -Xmx6G -jar server.jar nogui &
          echo $! > minecraft.pid
          echo "âœ… Server restarted successfully (new PID: $(cat minecraft.pid))"

      - name: â³ Keep Server alive
        run: |
          pid_file="minecraft.pid"

          # Náº¿u chÆ°a cÃ³ PID file thÃ¬ bÃ¡o lá»—i vÃ  dá»«ng
          if [ ! -f "$pid_file" ]; then
            echo "âŒ PID file not found â€” server may not be running."
            exit 1
          fi

          pid=$(cat "$pid_file")
          echo "ğŸ“¡ Monitoring Minecraft server (PID: $pid)..."

          # Kiá»ƒm tra trong 160 phÃºt (5 giÃ¢y/láº§n = 1920 láº§n)
          for i in $(seq 1 1920); do
            if ps -p "$pid" > /dev/null 2>&1; then
              echo "âœ… Server (PID $pid) is running (check $i/1920)..."
              sleep 5
            else
              echo "âš ï¸ Server stopped at check $i â€” will proceed to backup."
              exit 0
            fi
          done

          echo "â° Time limit reached (160m) â€” will proceed to backup."

      - name: ğŸ“¦ Save backup
        run: |
          zip -qr ".backup/server.zip" . -x ".git/*" ".github/*" ".backup/*" || true
          echo "âœ… Backup saved as server.zip"

      - name: ğŸ“¤ Push updated files
        run: |
          # Kiá»ƒm tra file backup tá»“n táº¡i khÃ´ng
          if [ -f ".backup/server.zip" ]; then
            # Upload file lÃªn Drive
            rclone copy .backup/server.zip server-backup: --update || echo "âŒ Upload failed."
            echo "âœ… Backup uploaded to Drive as server.zip"
          else
            echo "âš ï¸ No backup file to upload."
          fi
