name: Minecraft Server Pixelmon

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Start-Minecraft]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      # 1Ô∏è‚É£ T·∫°o folder backup
      - name: üìÅ Prepare backup folder
        run: mkdir -p .backup

      # 2Ô∏è‚É£ Restore backup n·∫øu c√≥
      - name: üíæ Restore backup (optional)
        run: |
          if [ -f ".backup/backup.zip" ]; then
            unzip -o ".backup/backup.zip" -d server/
            echo "‚úÖ Backup restored"
          else
            echo "‚ö†Ô∏è No backup found"
          fi

      # 3Ô∏è‚É£ Download Playit Linux CLI
      - name: ‚¨áÔ∏è Download Playit
        run: |
          wget -O playit https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64
          chmod +x playit
          nohup ./playit --secret 27b8c3d202823e43416721a8b026d78847f62426a54e14031fb2314d7d05bfcd &

      # 4Ô∏è‚É£ T·∫°o folder server
      - name: üìÇ Create server directory
        run: mkdir -p server

      # 5Ô∏è‚É£ Di chuy·ªÉn file ZIP v√†o server
      - name: üöö Move server.zip to server/
        run: mv server.zip server/

      # 6Ô∏è‚É£ Gi·∫£i n√©n server.zip
      - name: üì¶ Unzip server
        run: |
          cd server
          unzip -o server.zip
          rm server.zip

      # 7Ô∏è‚É£ Ch·∫°y Minecraft server ·∫©n n·ªÅn
      - name: ‚ñ∂Ô∏è Run Minecraft server
        run: |
          cd server
          echo "eula=true" > eula.txt
          nohup java -Xms1G -Xmx6G -jar server.jar nogui &

      # 8Ô∏è‚É£ Gi·ªØ VPS alive (t√πy ch·ªçn)
      - name: ‚è≥ Keep VPS alive
        run: |
          for i in $(seq 1 $((180))); do
            echo "üü¢ Running minute $i/180..."
            sleep 60
          done

      # 9Ô∏è‚É£ Backup server
      - name: üíæ Backup server
        working-directory: server
        run: |
          mkdir -p ../.backup
          rm -f ../.backup/*.zip
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          BACKUP_FILE="../.backup/backup-$TIMESTAMP.zip"
          zip -r "$BACKUP_FILE" ./*
          echo "‚úÖ Backup completed: $BACKUP_FILE"

      # 10Ô∏è‚É£ Upload artifact (kh√¥ng push repo)
      - uses: actions/upload-artifact@v3
        with:
          name: minecraft-backup
          path: .backup/*.zip
