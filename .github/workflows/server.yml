name: üéÆ Minecraft Server Pixelmon

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Ch·ªçn h√†nh ƒë·ªông (start / stop)"
        required: true
        default: "start"
  repository_dispatch:
    types: [Start-Server, Stop-Server]

jobs:
  start-server:
    if: >
      (github.event_name == 'repository_dispatch' && github.event.action == 'Start-Server')
      || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'start')
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 gi·ªù

    steps:
      - name: ‚¨áÔ∏è Download Server
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: üìÅ Prepare dirs
        run: |
          echo "Creating rclone config..."
          REMOTE_NAME="server-backup"
          RCLONE_CONF="$HOME/.config/rclone/rclone.conf"
          mkdir -p "$(dirname "$RCLONE_CONF")"
          cat > "$RCLONE_CONF" <<EOL
          [$REMOTE_NAME]
          type = drive
          client_id = 177351678679-j77al4hco0vgu0rtut2abm5b5lmkig34.apps.googleusercontent.com
          client_secret = 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
          scope = drive
          token = {"access_token":"ya29.a0AQQ_BDSifCrCJbr79_A6XwifyY1PQ8eroN8ZPyuf1UHzGFC5ILTWReOqpTViQTJ1YQfxgwvT3goPQBEP3JwmHyPehFTkaed3U-RE51ctVttfg21h9SN6HURZ5q7H0VPVZF8hzHgfDRSvfpUJ60FeGzPf4LZdjDZ_jeKwvsQ5khr4dnMOXUdwYRgyLQ0T0qPuWGZ5F28aCgYKAfkSARMSFQHGX2MiH3XnI0aShRvkbtMDZM6IKw0206","token_type":"Bearer","refresh_token":"1//0e2O7UOQ46-HnCgYIARAAGA4SNwF-L9IroOcdI-89WyM0hhRssZPRdQd3Z8P0PQxYdC3g-BYmj7w5OmmF1mMlaB_4dxYv2jmBkIM","expiry":"2025-10-12T08:20:52.4800863+07:00","expires_in":3599}
          team_drive =
          EOL
          echo "Testing rclone..."
          rclone ls "$REMOTE_NAME": || { echo "Rclone test failed!"; exit 1; }
          mkdir -p .backup

      - name: üíæ Restore backup (optional)
        run: |
          rclone copy server-backup:/server.zip .backup/ --transfers 16 --checkers 16
          if [ -f ".backup/server.zip" ]; then
            unzip -o ".backup/server.zip" -d .
            echo "‚úÖ Backup restored."
          else
            echo "‚ö†Ô∏è No backup found."
          fi

      - name: üöÄ Start Playit Tunnel
        run: |
          wget -q https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64 -O playit
          chmod +x playit
          nohup ./playit --secret 27b8c3d202823e43416721a8b026d78847f62426a54e14031fb2314d7d05bfcd > playit.log 2>&1 &
          echo "‚úÖ Playit started in background."

      - name: ‚ñ∂Ô∏è Run Minecraft server
        run: |
          sudo apt update
          sudo apt install -y openjdk-21-jdk
          sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/java-21-openjdk-amd64/bin/java 1
          sudo update-alternatives --set java /usr/lib/jvm/java-21-openjdk-amd64/bin/java
          java -version
          echo "eula=true" > eula.txt
          nohup java -Xms1G -Xmx6G -jar server.jar nogui &
          echo $! > minecraft.pid
          echo "‚úÖ Server restarted successfully (new PID: $(cat minecraft.pid))"

      - name: ‚è≥ Keep Server alive
        run: |
          pid_file="minecraft.pid"

          # N·∫øu ch∆∞a c√≥ PID file th√¨ b√°o l·ªói v√† d·ª´ng
          if [ ! -f "$pid_file" ]; then
            echo "‚ùå PID file not found ‚Äî server may not be running."
            exit 1
          fi

          pid=$(cat "$pid_file")
          echo "üì° Monitoring Minecraft server (PID: $pid)..."

          # Ki·ªÉm tra trong 160 ph√∫t (5 gi√¢y/l·∫ßn = 1920 l·∫ßn)
          for i in $(seq 1 1920); do
            if ps -p "$pid" > /dev/null 2>&1; then
              echo "‚úÖ Server (PID $pid) is running (check $i/1920)..."
              sleep 5
            else
              echo "‚ö†Ô∏è Server stopped at check $i ‚Äî will proceed to backup."
              exit 0
            fi
          done

          echo "‚è∞ Time limit reached (160m) ‚Äî will proceed to backup."

      - name: üì¶ Save backup
        run: |
          zip -qr ".backup/server.zip" . -x ".git/*" ".github/*" ".backup/*" || true
          echo "‚úÖ Backup saved as server.zip"

      - name: üì§ Push updated files
        run: |
          # Ki·ªÉm tra file backup t·ªìn t·∫°i kh√¥ng
          if [ -f ".backup/server.zip" ]; then
            # Upload file l√™n Drive
            rclone copy .backup/server.zip server-backup: --update || echo "‚ùå Upload failed."
            echo "‚úÖ Backup uploaded to Drive as server.zip"
          else
            echo "‚ö†Ô∏è No backup file to upload."
          fi


  stop-server:
    if: >
      (github.event_name == 'repository_dispatch' && github.event.action == 'Stop-Server')
      || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'stop')
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: üì¶ Download mcrcon
        run: |
          curl -L -o mcrcon.tar.gz https://github.com/Tiiffi/mcrcon/releases/download/v0.7.2/mcrcon-0.7.2-linux-x86-64.tar.gz
          tar -xzf mcrcon.tar.gz
          echo "üîê C·∫•p quy·ªÅn cho mcrcon..."
          chmod +x mcrcon

      - name: üîç Test RCON Connection
        continue-on-error: true
        run: |
          echo "üß† Testing RCON connectivity..."
          if timeout 5 ./mcrcon -H 147.185.221.229 -P 24907 -p 26022009 "list"; then
            echo "‚úÖ RCON connection successful!"
          else
            echo "‚ö†Ô∏è RCON connection failed or timed out!"
          fi

      - name: üõë Stop Minecraft Server via RCON
        run: |
          echo "üì¢ G·ª≠i th√¥ng b√°o..."
          ./mcrcon -H 147.185.221.229 -P 24907 -p 26022009 "say Server will stop in 10 seconds!"
          sleep 5
          for i in {5..1}; do
            ./mcrcon -H 147.185.221.229 -P 24907 -p 26022009 "say Server will stop in $i seconds!"
            sleep 1
          done

          ./mcrcon -H 147.185.221.229 -P 24907 -p 26022009 "say Server is stopping now!"
          ./mcrcon -H 147.185.221.229 -P 24907 -p 26022009 "stop"

          echo "‚úÖ Server stopped successfully!"
